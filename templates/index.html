<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Example</title>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.0/dist/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/adapter.js') }}"></script>
</head>

<body>
    <h1>WebRTC Test</h1>

    <label for="sender">Sender</label>
    <input type="checkbox" id="sender" />
    <label for="receiver">Receiver</label>
    <input type="checkbox" id="receiver" />

    <!-- Start button -->
    <button id="startButton">Start</button>

    <div id="status">Status: Waiting for connection...</div>

    <script>
        const socket = io();  // Connect to the signaling server

        const peerConnectionConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }  // Google's STUN server
            ]
        };

        let localStream;
        let peerConnection;
        let dataChannel;

        // Create a peer connection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(peerConnectionConfig);

            // ICE candidate handler
            peerConnection.onicecandidate = function (event) {
                if (event.candidate) {
                    sendCandidate(event.candidate);
                }
            };

            // Add the video and audio tracks from the local stream
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // Listen for ICE connection state changes
            peerConnection.oniceconnectionstatechange = function () {
                console.log("ICE connection state: ", peerConnection.iceConnectionState);
            };

            // Listen for remote stream
            peerConnection.ontrack = function (event) {
                console.log('Remote track received');
                const remoteVideo = document.getElementById('remote-video');
                remoteVideo.srcObject = event.streams[0];
            };
        }

        // Start the connection by creating an offer if sender is checked
        function startConnection() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    localStream = stream;
                    const localVideo = document.createElement('video');
                    localVideo.srcObject = stream;
                    document.body.appendChild(localVideo);  // Show local video

                    createPeerConnection();

                    // Check if the user selected sender checkbox
                    if (document.getElementById('sender').checked) {
                        // Create an offer if sender is selected
                        peerConnection.createOffer()
                            .then(offer => {
                                return peerConnection.setLocalDescription(offer);
                            })
                            .then(() => {
                                sendOffer(peerConnection.localDescription);
                            })
                            .catch(error => console.log('Error creating offer: ', error));
                    }
                })
                .catch(error => console.log('Error getting media: ', error));
        }

        // Send Offer to Server
        function sendOffer(offer) {
            socket.emit('offer', offer);
        }

        // Send Answer to Server
        function sendAnswer(answer) {
            socket.emit('answer', answer);
        }

        // Send ICE Candidate to Server
        function sendCandidate(candidate) {
            socket.emit('candidate', candidate);
        }

        // Receive Offer
        socket.on('offer', offer => {
            if (document.getElementById('receiver').checked) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                    .then(() => peerConnection.createAnswer())
                    .then(answer => {
                        return peerConnection.setLocalDescription(answer);
                    })
                    .then(() => {
                        sendAnswer(peerConnection.localDescription);
                    })
                    .catch(error => console.log('Error handling offer: ', error));
            }
        });

        // Receive Answer
        socket.on('answer', answer => {
            if (document.getElementById('sender').checked) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
                    .catch(error => console.log('Error handling answer: ', error));
            }
        });

        // Receive ICE Candidate
        socket.on('candidate', candidate => {
            peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                .catch(error => console.log('Error adding ICE candidate: ', error));
        });

        // Event listener for the Start button
        document.getElementById('startButton').addEventListener('click', () => {
            // Check if either sender or receiver is selected
            if (document.getElementById('sender').checked || document.getElementById('receiver').checked) {
                startConnection();
            } else {
                alert('Please select either Sender or Receiver.');
            }
        });
    </script>

    <video id="remote-video" autoplay></video> <!-- For showing remote video -->
</body>

</html>